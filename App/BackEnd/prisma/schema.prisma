generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication Models
// ============================================

enum Role {
  ADMIN
  MEMBER
  VIEWER
}

model user {
  id             String    @id @default(uuid())
  email          String    @unique
  password_hash  String
  name           String
  role           Role      @default(MEMBER)
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  last_login     DateTime?

  sessions       session[]
  job_history    job_history[]

  @@index([email])
  @@index([role])
}

model session {
  id            String   @id @default(uuid())
  user_id       String
  refresh_token String   @unique
  user_agent    String?
  ip_address    String?
  expires_at    DateTime
  created_at    DateTime @default(now())

  user          user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([refresh_token])
  @@index([expires_at])
}

// ============================================
// Business Models
// ============================================

model business {
  id                 Int                  @id @default(autoincrement())
  name               String
  address            String?
  city               String?
  state              String?              @default("NJ")
  zip                String?
  phone              String?
  website            String?
  business_type      String?
  industry           String?
  employee_count     Int?
  year_founded       Int?
  google_maps_url    String?
  latitude           Float?
  longitude          Float?
  enrichment_status  String               @default("pending") // pending, enriched, failed
  source             String               @default("google_maps")
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt

  contacts           contact[]
  enrichment_logs    enrichment_log[]
  outreach_messages  outreach_message[]
  api_cost_logs      api_cost_log[]

  @@index([city])
  @@index([industry])
  @@index([enrichment_status])
}

model contact {
  id                 Int                  @id @default(autoincrement())
  business_id        Int
  name               String?
  title              String?
  email              String?
  email_verified     Boolean?             @default(false)
  phone              String?
  linkedin_url       String?
  is_primary         Boolean              @default(false)
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  
  business           business             @relation(fields: [business_id], references: [id], onDelete: Cascade)
  outreach_messages  outreach_message[]

  @@index([business_id])
  @@index([email])
}

model enrichment_log {
  id                 Int                  @id @default(autoincrement())
  business_id        Int
  service            String               // hunter, abstract
  status             String               // success, failed
  request_data       String?              @db.Text
  response_data      String?              @db.Text
  error_message      String?              @db.Text
  created_at         DateTime             @default(now())
  
  business           business             @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([service])
  @@index([status])
}

model outreach_message {
  id                 Int                  @id @default(autoincrement())
  business_id        Int
  contact_id         Int?
  message_text       String               @db.Text
  generated_at       DateTime             @default(now())
  sent_at            DateTime?
  status             String               @default("generated") // generated, sent, failed

  business           business             @relation(fields: [business_id], references: [id], onDelete: Cascade)
  contact            contact?             @relation(fields: [contact_id], references: [id], onDelete: SetNull)

  @@index([business_id])
  @@index([status])
}

model job_history {
  id                 String               @id @default(uuid())
  jobId              String               @unique
  queueName          String
  jobType            String
  status             String               // pending, active, completed, failed, delayed, paused
  data               Json
  result             Json?
  error              Json?
  progress           Int                  @default(0)
  attemptsMade       Int                  @default(0)
  maxAttempts        Int                  @default(3)
  userId             String?
  createdAt          DateTime             @default(now())
  startedAt          DateTime?
  completedAt        DateTime?
  failedAt           DateTime?

  user               user?                @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([queueName, status])
  @@index([createdAt])
}

// ============================================
// Analytics Models
// ============================================

model scraping_job {
  id                 String      @id @default(uuid())
  job_id             String      @unique
  location           String
  radius             Float
  business_type      String?
  max_results        Int
  status             String
  businesses_found   Int         @default(0)
  businesses_saved   Int         @default(0)
  apify_cost         Float       @default(0)
  completed_at       DateTime?
  created_at         DateTime    @default(now())

  @@index([status])
  @@index([created_at])
}

model api_cost_log {
  id             Int       @id @default(autoincrement())
  operation_type String    // scrape, enrich_hunter, enrich_abstract
  service        String    // apify, hunter, abstract
  business_id    Int?
  cost_usd       Float
  metadata       Json?
  created_at     DateTime  @default(now())

  business       business? @relation(fields: [business_id], references: [id], onDelete: SetNull)

  @@index([service])
  @@index([created_at])
}
